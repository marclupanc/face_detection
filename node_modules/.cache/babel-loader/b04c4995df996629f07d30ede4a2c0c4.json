{"ast":null,"code":"import { minBbox } from '../ops';\nimport { getCenterPoint } from '../utils';\nimport { Box } from './Box';\nimport { Dimensions } from './Dimensions';\nimport { FaceDetection } from './FaceDetection';\nimport { Point } from './Point';\nimport { Rect } from './Rect'; // face alignment constants\n\nvar relX = 0.5;\nvar relY = 0.43;\nvar relScale = 0.45;\n\nvar FaceLandmarks =\n/** @class */\nfunction () {\n  function FaceLandmarks(relativeFaceLandmarkPositions, imgDims, shift) {\n    if (shift === void 0) {\n      shift = new Point(0, 0);\n    }\n\n    var width = imgDims.width,\n        height = imgDims.height;\n    this._imgDims = new Dimensions(width, height);\n    this._shift = shift;\n    this._positions = relativeFaceLandmarkPositions.map(function (pt) {\n      return pt.mul(new Point(width, height)).add(shift);\n    });\n  }\n\n  Object.defineProperty(FaceLandmarks.prototype, \"shift\", {\n    get: function () {\n      return new Point(this._shift.x, this._shift.y);\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(FaceLandmarks.prototype, \"imageWidth\", {\n    get: function () {\n      return this._imgDims.width;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(FaceLandmarks.prototype, \"imageHeight\", {\n    get: function () {\n      return this._imgDims.height;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(FaceLandmarks.prototype, \"positions\", {\n    get: function () {\n      return this._positions;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(FaceLandmarks.prototype, \"relativePositions\", {\n    get: function () {\n      var _this = this;\n\n      return this._positions.map(function (pt) {\n        return pt.sub(_this._shift).div(new Point(_this.imageWidth, _this.imageHeight));\n      });\n    },\n    enumerable: true,\n    configurable: true\n  });\n\n  FaceLandmarks.prototype.forSize = function (width, height) {\n    return new this.constructor(this.relativePositions, {\n      width: width,\n      height: height\n    });\n  };\n\n  FaceLandmarks.prototype.shiftBy = function (x, y) {\n    return new this.constructor(this.relativePositions, this._imgDims, new Point(x, y));\n  };\n\n  FaceLandmarks.prototype.shiftByPoint = function (pt) {\n    return this.shiftBy(pt.x, pt.y);\n  };\n  /**\r\n   * Aligns the face landmarks after face detection from the relative positions of the faces\r\n   * bounding box, or it's current shift. This function should be used to align the face images\r\n   * after face detection has been performed, before they are passed to the face recognition net.\r\n   * This will make the computed face descriptor more accurate.\r\n   *\r\n   * @param detection (optional) The bounding box of the face or the face detection result. If\r\n   * no argument was passed the position of the face landmarks are assumed to be relative to\r\n   * it's current shift.\r\n   * @returns The bounding box of the aligned face.\r\n   */\n\n\n  FaceLandmarks.prototype.align = function (detection, options) {\n    if (options === void 0) {\n      options = {};\n    }\n\n    if (detection) {\n      var box = detection instanceof FaceDetection ? detection.box.floor() : new Box(detection);\n      return this.shiftBy(box.x, box.y).align(null, options);\n    }\n\n    var _a = Object.assign({}, {\n      useDlibAlignment: false,\n      minBoxPadding: 0.2\n    }, options),\n        useDlibAlignment = _a.useDlibAlignment,\n        minBoxPadding = _a.minBoxPadding;\n\n    if (useDlibAlignment) {\n      return this.alignDlib();\n    }\n\n    return this.alignMinBbox(minBoxPadding);\n  };\n\n  FaceLandmarks.prototype.alignDlib = function () {\n    var centers = this.getRefPointsForAlignment();\n    var leftEyeCenter = centers[0],\n        rightEyeCenter = centers[1],\n        mouthCenter = centers[2];\n\n    var distToMouth = function (pt) {\n      return mouthCenter.sub(pt).magnitude();\n    };\n\n    var eyeToMouthDist = (distToMouth(leftEyeCenter) + distToMouth(rightEyeCenter)) / 2;\n    var size = Math.floor(eyeToMouthDist / relScale);\n    var refPoint = getCenterPoint(centers); // TODO: pad in case rectangle is out of image bounds\n\n    var x = Math.floor(Math.max(0, refPoint.x - relX * size));\n    var y = Math.floor(Math.max(0, refPoint.y - relY * size));\n    return new Rect(x, y, Math.min(size, this.imageWidth + x), Math.min(size, this.imageHeight + y));\n  };\n\n  FaceLandmarks.prototype.alignMinBbox = function (padding) {\n    var box = minBbox(this.positions);\n    return box.pad(box.width * padding, box.height * padding);\n  };\n\n  FaceLandmarks.prototype.getRefPointsForAlignment = function () {\n    throw new Error('getRefPointsForAlignment not implemented by base class');\n  };\n\n  return FaceLandmarks;\n}();\n\nexport { FaceLandmarks };","map":{"version":3,"mappings":"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","names":["minBbox","getCenterPoint","Box","Dimensions","FaceDetection","Point","Rect","relX","relY","relScale","relativeFaceLandmarkPositions","imgDims","shift","height","_imgDims","width","_shift","_positions","map","mul","add","Object","FaceLandmarks","x","y","sub","_this","div","imageWidth","imageHeight","constructor","relativePositions","pt","shiftBy","detection","options","box","floor","align","useDlibAlignment","minBoxPadding","alignDlib","alignMinBbox","centers","getRefPointsForAlignment","rightEyeCenter","mouthCenter","distToMouth","magnitude","eyeToMouthDist","leftEyeCenter","size","Math","refPoint","max","min","padding","positions","pad","Error"],"sources":["../../../src/classes/FaceLandmarks.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}